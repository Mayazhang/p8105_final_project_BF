---
title: "About This Project"
---

```{r}
library(tidyverse)
library(readxl)
library(PerformanceAnalytics)
library(rvest)
library(httr)
```
Load drug data and clean up

```{r drug dataset load and clean up}
# Remove the block later
drug_raw =
  read_csv("./data/drugs.csv") %>%
  janitor::clean_names()

drug_clean = 
  drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", ""))

population_data = 
  drug_raw %>% 
  select(x12_17, x18_25:x26, year, state) %>% 
  gather(key = "age", value = "popul_in_thousands", -state, -year) %>% 
  mutate(age = str_replace(age, "x", ""))
```


#### Get Y and X for regression

Y: 51 states, each with mean crime rates (10 types of crimes)

```{r}
crime_mean_rate <- 
  crime_clean %>% 
  group_by(state) %>% 
  select(grep("rate",names(.))) %>% 
  summarise_all(funs(mean))
crime_mean_rate[,2:11] <- crime_mean_rate[,2:11]/100

# check dimension
dim(crime_mean_rate) #right
head(crime_mean_rate)
```

X: 51 states, each with mean drug rate (3 types of drugs)

```{r prepare the outcome and predictors}
# clean drug data
drug_mean_rate = drug_clean %>% 
  group_by(state, rate, age) %>% 
  summarize(drug_average = mean(value)) %>% 
  group_by(state, rate) %>% 
  summarize(drug_sum = sum(drug_average)) %>% 
  filter(!str_detect(rate, 'perceptions'),
         str_detect(rate, 'past_year')) %>% 
  mutate(rate = str_replace_all(rate, c("alcohol_" = "alcohol:", "illicit_drugs_" = "illicit_drugs:", "marijuana_" = "marijuana:"))) %>% 
  separate(rate, into = c("drug", "degree"), sep = ":", extra = "merge") %>% 
  select(-degree) %>% 
  group_by(state, drug) %>% 
  summarize(use_past_year = sum(drug_sum)) %>% 
# up to here, it's already a tidy dataset, but for regression we need to define each drug as a variable, so we choose to spread "drug" column
  spread(key = drug, value = use_past_year)

head(drug_mean_rate)

# read data for race proportion
race_data_raw = read_csv("./data/race_data.csv") %>% janitor::clean_names() %>%
  select(state, white)

# Combine X and Y into one data frame
regression_data_raw = left_join(crime_mean_rate, drug_mean_rate) %>% 
  select(-rape_legacy_rate)

regression_data_raw = left_join(regression_data_raw, race_data_raw)
```

Consider education as a new variable.

```{r read in new dataset}
# Import dataset that contains education information
url = "https://en.wikipedia.org/wiki/List_of_U.S._states_by_educational_attainment"
education = read_html(url)

# tidy and clean
education_data = education %>% 
  html_nodes(css = "table") %>%
  .[[1]] %>% 
  html_table(fill = TRUE) %>% 
  janitor::clean_names() %>% 
  select(state, percent_high_school_graduate) %>% 
  filter(state != "United States") %>% 
  mutate(percent_high_school_graduate = str_replace(percent_high_school_graduate, "%", "")) %>% 
  mutate(percent_high_school_graduate = as.numeric(percent_high_school_graduate))

```


#### Linear Regression

Check the distribution for variables.
```{r distribution checking}
# Check distributions 
regression_data_all %>%
  select(-state) %>%
  chart.Correlation()
```


Make models for MLR of crime types and drug uses. 
```{r linear regression}
# Make linear models for each crime type in each state
regression_model = 
  regression_data_raw %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest()

# Filter the model that has p-value is less than 0.1
regression_model %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")
```

* Put "population" into the model

Set the significant level at 0.5

```{r}
# Clean up the population data to get the average in each state
population_data = population_data %>% 
  group_by(state, age) %>% 
  summarize(mean_pop = mean(popul_in_thousands)) %>% 
  group_by(state) %>% 
  summarize(total_pop_thousands = sum(mean_pop))

new_reg_data = left_join(regression_data_raw, population_data)

# Construct new regression models
new_reg_data %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  mutate(crime_type = str_replace(crime_type, "_rate", "")) %>% 
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + total_pop_thousands, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")
```

* Explore model with education data

```{r}
regression_data_all = left_join(regression_data_raw, education_data)
regression_data_all %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")

model = lm(murder_manslaughter_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = regression_data_all)
summary(model)
plot(model)
```

Check the diagnostics of the model.

```{r diagnostics for each models}
# Fit models and then check the assumption
burglary_model = lm(burglary_rate ~ illicit_drugs + alcohol + marijuana + total_pop_thousands + white, data = new_reg_data)
summary(burglary_model)
```

From the diagnostics, this models meets the model assumptions.
From the result we could see that, both murder/manslaughter and burglary rate are inversely related to alcohol use while robbery rate is positively related to marijuana use. Thus, now we look into simple linear models for each association

From the results of regression model that includes "total_population" as variable, we can see that at the significant level of 0.1, both murder/manslaughter and burglary rates are inversely related to alcohol use while robbery rate is positively associated to marijuana use. So we would look into the model assumptions

From the diagnostics, the simple linear model of murder rate and alcohol use has a relatively better residual distribution, and there is no heavy tails in the QQ plot. However, the redisuals vs fitted plot of the model of burglary rate and alcohol, has a skewed line. Therefore, it may not meet the assumption.

* Try bootstrap of the model of burglary rate

```{r}
new_reg_data %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  filter(crime_type == "burglary_rate") %>% 
  modelr::bootstrap(n = 100) %>% 
  mutate(
    linear_model = map(strap, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + total_pop_thousands, data = .x)),
    results = map(linear_model, broom::tidy)) %>% 
  select(results) %>%
  unnest()
```

