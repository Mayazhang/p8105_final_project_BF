---
title: "About This Project"
---


#### load crime and drug data and do some clean up!

first draft, change anything if you would like --Hongyao

```{r}
library(tidyverse)
library(readxl)
```

Load crime data and some primary clean up

```{r}
# load data and clean up column names
# not to omit NAs
crime = readxl::read_excel("./data/crime-data-2016.xls", range = ("A4:W202")) %>% 
  janitor::clean_names() %>% 
    rename_(population = names(.)[3],
          violent_crime_number = names(.)[4],
          violent_crime_rate = names(.)[5],
          murder_manslaughter_number = names(.)[6],
          murder_manslaughter_rate = names(.)[7],
          rape_revise_number = names(.)[8],
          rape_revise_rate = names(.)[9],
          rape_legacy_number = names(.)[10],
          rape_legacy_rate = names(.)[11],
          robbery_number = names(.)[12],
          robbery_rate = names(.)[13],
          aggravated_assault_number = names(.)[14],
          aggravated_assault_rate = names(.)[15],
          property_crime_number = names(.)[16],
          property_crime_rate = names(.)[17],
          burglary_number = names(.)[18],
          burglary_rate = names(.)[19],
          larceny_theft_number = names(.)[20],
          larceny_theft_rate = names(.)[21],
          motor_vehicle_theft_number = names(.)[22],
          motor_vehicle_theft_rate = names(.)[23]) %>% 
  mutate(area = as.factor(area)) 
crime[,2:23] <- as.numeric(unlist(crime[,2:23]))

# fill up area name
i = 1
for(i in 0:65) {
  n = 3 * i + 1
  crime$area[n + 1] = paste0(crime$area[n]) 
  crime$area[n + 2] = paste0(crime$area[n])
  i = i + 1
}

# check head
head(crime)
```

some further clean up on crime data 

```{r data cleaning on crime dataset}
# Filter out "percent change" in "year" variable
crime_clean = 
  crime %>%
  filter(year != "NA")

# Create a new dataframe to store the data of different large areas
crime_largearea = 
  crime_clean %>%
  filter(area %in% c("United States Total", "Northeast", "Midwest", "South", "West"))

# Create subtotal for each big areas
crime_northeast = 
  crime_clean %>%
  filter(area %in% c("New England", "Middle Atlantic"))

crime_midwest = 
  crime_clean %>%
  filter(area %in% c("East North Central", "West North Central"))

crime_south = 
  crime_clean %>%
  filter(area %in% c("South Atlantic", "East South Central", "West South Central"))

crime_west = 
  crime_clean %>%
  filter(area %in% c("Mountain", "Pacific", "Puerto Rico"))

# Change the name of "area" to "state"
colnames(crime_clean)[1] = "state"

# Filter out these areas in the tidied dataset
crime_clean = 
  crime_clean %>%
  filter(!state %in% c("United States Total", "Northeast", "Midwest", "South", "West", "New England", "Middle Atlantic", "East North Central", "West North Central", "South Atlantic", "East South Central", "West South Central", "Mountain", "Pacific", "Puerto Rico"))
```

load drug data and clean up

```{r drug dataset load and clean up}
# Remove the block later
drug_raw =
  read_csv("./data/drugs.csv") %>%
  janitor::clean_names()

drug_data = 
  drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", "")) %>% 
  spread(rate, value)

population_data = 
  drug_raw %>% 
  select(x12_17, x18_25:x26, year, state) %>% 
  gather(key = "age", value = "popul_in_thousands", -state, -year) %>% 
  mutate(age = str_replace(age, "x", ""))

drug_clean = left_join(drug_data, population_data)
```


#### Get Y and X for regression

Y: 51 states, each with mean crime rates (10 types of crimes)

```{r}
crime_mean_rate <- 
  crime_clean %>% 
  group_by(state) %>% 
  select(grep("rate",names(.))) %>% 
  summarise_all(funs(mean))
crime_mean_rate[,2:11] <- crime_mean_rate[,2:11]/100

# check dimension
dim(crime_mean_rate) #right
head(crime_mean_rate)
```

X: 51 states, each with mean drug rate (3 types of drugs)

```{r}
drug_sum_row = drug_clean %>% 
  group_by(state, age) %>%
  select(-year) %>% 
  summarise_all(funs(mean)) %>% 
  group_by(state) %>% 
  select(-age) %>% 
  summarise_all(funs(sum))

drug_sum_alcohol <-
  drug_sum_row %>% 
  select(grep("alcohol",names(.))) %>%
  mutate(alcohol_sum = rowSums(.[1:6])) %>% 
  select(alcohol_sum)

drug_sum_illicit <-
  drug_sum_row %>% 
  select(grep("illicit",names(.))) %>%
  mutate(illicit_sum = rowSums(.[1:4])) %>% 
  select(illicit_sum)

drug_sum_marijuana <-
  drug_sum_row %>% 
  select(grep("marijuana",names(.))) %>%
  mutate(marijuana_sum = rowSums(.[1:4])) %>% 
  select(marijuana_sum)

drug_mean_rate <- cbind(drug_sum_row$state, drug_sum_alcohol, drug_sum_illicit, drug_sum_marijuana)

head(drug_mean_rate)

# Combine X and Y into one data frame
regression_data_raw = cbind(crime_mean_rate,drug_mean_rate) %>%
  select(-rape_legacy_rate, -`drug_sum_row$state`)
```

#### Linear Regression

```{r linear regression}
# Make linear models for each crime type in each state
regression_data = 
  regression_data_raw %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_sum + alcohol_sum + marijuana_sum, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest()
```


#### some graphs

Group by districts(i.e. Northeast, Midwest, South, West), each district can be subdivide into smaller categories(e.g. Northeast can be divided into New England and Middle Atlantic), which is not explored at the moment(but could be later)

Change anything if you want (HX)

```{r}
# rank areas by average violent crime rate from 2015 to 2016
crime %>% 
  group_by(area) %>% 
  filter(year != "Percent change") %>%
  summarise_each(funs(mean)) %>%
  mutate(area = fct_reorder(area, violent_crime_rate)) %>% 
  ggplot(aes(x = area, y = violent_crime_rate)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, size = 8),
        title = element_text(size = 6))
```



```{r distribution of violent crime rate for each state}
ggplot(crime_clean, aes(x = violent_crime_rate)) + geom_histogram() +
  theme_bw()
```









