---
title: "About This Project"
---


#### load crime and drug data and do some clean up!

```{r}
library(tidyverse)
library(readxl)
library(PerformanceAnalytics)
library(rvest)
library(httr)
```

Load crime data and some primary clean up

```{r}
# load data and clean up column names
# not to omit NAs
crime = readxl::read_excel("./data/crime-data-2016.xls", range = ("A4:W202")) %>% 
  janitor::clean_names() %>% 
    rename_(population = names(.)[3],
          violent_crime_number = names(.)[4],
          violent_crime_rate = names(.)[5],
          murder_manslaughter_number = names(.)[6],
          murder_manslaughter_rate = names(.)[7],
          rape_revise_number = names(.)[8],
          rape_revise_rate = names(.)[9],
          rape_legacy_number = names(.)[10],
          rape_legacy_rate = names(.)[11],
          robbery_number = names(.)[12],
          robbery_rate = names(.)[13],
          aggravated_assault_number = names(.)[14],
          aggravated_assault_rate = names(.)[15],
          property_crime_number = names(.)[16],
          property_crime_rate = names(.)[17],
          burglary_number = names(.)[18],
          burglary_rate = names(.)[19],
          larceny_theft_number = names(.)[20],
          larceny_theft_rate = names(.)[21],
          motor_vehicle_theft_number = names(.)[22],
          motor_vehicle_theft_rate = names(.)[23]) %>% 
  mutate(area = as.factor(area)) 
crime[,2:23] <- as.numeric(unlist(crime[,2:23]))

# fill up area name
i = 1
for (i in 0:65) {
  n = 3 * i + 1
  crime$area[n + 1] = paste0(crime$area[n]) 
  crime$area[n + 2] = paste0(crime$area[n])
  i = i + 1
}

crime  <- crime %>% 
  na.omit()

crime$year = as.factor(crime$year)
# check head
head(crime)
```

some further clean up on crime data 

```{r data cleaning on crime dataset}
# Filter out "percent change" in "year" variable
crime_clean = 
  crime %>%
  filter(year != "NA")

# Create a new dataframe to store the data of different large areas
crime_largearea = 
  crime_clean %>%
  filter(area %in% c("United States Total", "Northeast", "Midwest", "South", "West"))

# Create subtotal for each big areas
crime_northeast = 
  crime_clean %>%
  filter(area %in% c("New England", "Middle Atlantic"))

crime_midwest = 
  crime_clean %>%
  filter(area %in% c("East North Central", "West North Central"))

crime_south = 
  crime_clean %>%
  filter(area %in% c("South Atlantic", "East South Central", "West South Central"))

crime_west = 
  crime_clean %>%
  filter(area %in% c("Mountain", "Pacific", "Puerto Rico"))

# Change the name of "area" to "state"
colnames(crime_clean)[1] = "state"

# Filter out these areas in the tidied dataset
crime_clean = 
  crime_clean %>%
  filter(!state %in% c("United States Total", "Northeast", "Midwest", "South", "West", "New England", "Middle Atlantic", "East North Central", "West North Central", "South Atlantic", "East South Central", "West South Central", "Mountain", "Pacific", "Puerto Rico"))
```

#### Some Graphs

Group by districts(i.e. Northeast, Midwest, South, West), each district can be subdivide into smaller categories.

```{r}
# rank areas by average violent crime rate from 2015 to 2016
crime %>% 
  group_by(area) %>% 
  filter(year != "Percent change") %>%
  summarise_each(funs(mean)) %>%
  mutate(area = fct_reorder(area, violent_crime_rate)) %>% 
  ggplot(aes(x = area, y = violent_crime_rate)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, size = 8),
        title = element_text(size = 6))
```


Visualize the crime distribution at different geographic levels.
```{r distribution of violent crime rate}
# At state level
ggplot(crime_clean, aes(x = state, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, size = 10)) +
  labs(
    title = "Crime Rate in Each State",
    x = "State",
    y = "Crime Rate (Per 100000)"
  )

# At area level
ggplot(crime_largearea, aes(x = area, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Crime Rate in Each Area",
    x = "Area",
    y = "Crime Rate (Per 100000)"
  ) 

# In the midwest area
ggplot(crime_midwest, aes(x = area, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Crime Rate in Midwest Area",
    x = "Regions",
    y = "Crime Rate (Per 100000)"
  ) 

# In the northeast area
ggplot(crime_northeast, aes(x = area, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Crime Rate in Northeast Area",
    x = "Regions",
    y = "Crime Rate (Per 100000)"
  ) 

# In the south area
ggplot(crime_south, aes(x = area, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Crime Rate in South Area",
    x = "Regions",
    y = "Crime Rate (Per 100000)"
  ) 

# In the west area
ggplot(crime_west, aes(x = area, y = violent_crime_rate, color = year)) + geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Crime Rate in West Area",
    x = "Regions",
    y = "Crime Rate (Per 100000)"
  ) 
```




Load drug data and clean up

```{r drug dataset load and clean up}
# Remove the block later
drug_raw =
  read_csv("./data/drugs.csv") %>%
  janitor::clean_names()

drug_clean = 
  drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", ""))

population_data = 
  drug_raw %>% 
  select(x12_17, x18_25:x26, year, state) %>% 
  gather(key = "age", value = "popul_in_thousands", -state, -year) %>% 
  mutate(age = str_replace(age, "x", ""))
```


#### Get Y and X for regression

Y: 51 states, each with mean crime rates (10 types of crimes)

```{r}
crime_mean_rate <- 
  crime_clean %>% 
  group_by(state) %>% 
  select(grep("rate",names(.))) %>% 
  summarise_all(funs(mean))
crime_mean_rate[,2:11] <- crime_mean_rate[,2:11]/100

# check dimension
dim(crime_mean_rate) #right
head(crime_mean_rate)
```

X: 51 states, each with mean drug rate (3 types of drugs)

```{r prepare the outcome and predictors}
# clean drug data
drug_mean_rate = drug_clean %>% 
  group_by(state, rate, age) %>% 
  summarize(drug_average = mean(value)) %>% 
  group_by(state, rate) %>% 
  summarize(drug_sum = sum(drug_average)) %>% 
  filter(!str_detect(rate, 'perceptions'),
         str_detect(rate, 'past_year')) %>% 
  mutate(rate = str_replace_all(rate, c("alcohol_" = "alcohol:", "illicit_drugs_" = "illicit_drugs:", "marijuana_" = "marijuana:"))) %>% 
  separate(rate, into = c("drug", "degree"), sep = ":", extra = "merge") %>% 
  select(-degree) %>% 
  group_by(state, drug) %>% 
  summarize(use_past_year = sum(drug_sum)) %>% 
# up to here, it's already a tidy dataset, but for regression we need to define each drug as a variable, so we choose to spread "drug" column
  spread(key = drug, value = use_past_year)

head(drug_mean_rate)

# read data for race proportion
race_data_raw = read_csv("./data/race_data.csv") %>% janitor::clean_names() %>%
  select(state, white)

# Combine X and Y into one data frame
regression_data_raw = left_join(crime_mean_rate, drug_mean_rate) %>% 
  select(-rape_legacy_rate)

regression_data_raw = left_join(regression_data_raw, race_data_raw)
```

#### Linear Regression
Check the distribution for variables.
```{r distribution checking}
# Check distributions 
regression_data_raw %>%
  select(-state) %>%
  chart.Correlation()
```


Make models for MLR of crime types and drug uses. 
```{r linear regression}
# Make linear models for each crime type in each state
regression_model = 
  regression_data_raw %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest()

# Filter the model that has p-value is less than 0.1
regression_model %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")
```

* Put "population" into the model

Set the significant level at 0.5

```{r}
# Clean up the population data to get the average in each state
population_data = population_data %>% 
  group_by(state, age) %>% 
  summarize(mean_pop = mean(popul_in_thousands)) %>% 
  group_by(state) %>% 
  summarize(total_pop_thousands = sum(mean_pop))

new_reg_data = left_join(regression_data_raw, population_data)

# Construct new regression models
new_reg_data %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  mutate(crime_type = str_replace(crime_type, "_rate", "")) %>% 
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + total_pop_thousands, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")
```

From the result, we could see that only burglary contains estimated coefficient of drug use variable with low p-value. So we pick this type of crime as our final outcome.

Check the diagnostics of the model.

```{r diagnostics for each models}
# Fit models and then check the assumption
burglary_model = lm(burglary_rate ~ illicit_drugs + alcohol + marijuana + total_pop_thousands + white, data = new_reg_data)
summary(burglary_model)
```

From the diagnostics, these three models all meet the model assumptions.
From the result we could see that, both murder/manslaughter and burglary rate are inversely related to alcohol use while robbery rate is positively related to marijuana use. Thus, now we look into simple linear models for each association

From the results of regression model that includes "total_population" as variable, we can see that at the significant level of 0.1, both murder/manslaughter and burglary rates are inversely related to alcohol use while robbery rate is positively associated to marijuana use. So we would look into the model assumptions

```{r model assumptions check for SLR models}
# Make models and see the diagnostic graphs
SLR_murder_alcohol = lm(murder_manslaughter_rate ~ alcohol, data = new_reg_data)
plot(SLR_murder_alcohol)

SLR_burglary_alcohol = lm(burglary_rate ~ alcohol, data = new_reg_data)
plot(SLR_burglary_alcohol)
```

From the diagnostics, the simple linear model of murder rate and alcohol use has a relatively better residual distribution, and there is no heavy tails in the QQ plot. However, the redisuals vs fitted plot of the model of burglary rate and alcohol, has a skewed line. Therefore, it may not meet the assumption.

* Try bootstrap of the model of burglary rate

```{r}
new_reg_data %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  filter(crime_type == "burglary_rate") %>% 
  modelr::bootstrap(n = 100) %>% 
  mutate(
    linear_model = map(strap, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + total_pop_thousands, data = .x)),
    results = map(linear_model, broom::tidy)) %>% 
  select(results) %>%
  unnest()
```





