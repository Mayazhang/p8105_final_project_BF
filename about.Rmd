---
title: "About This Project"
---

```{r}
library(tidyverse)
library(readxl)
library(PerformanceAnalytics)
library(rvest)
library(httr)
```
Load drug data and clean up

```{r drug dataset load and clean up}
# Remove the block later
drug_raw =
  read_csv("./data/drugs.csv") %>%
  janitor::clean_names()

drug_clean = 
  drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", ""))

population_data = 
  drug_raw %>% 
  select(x12_17, x18_25:x26, year, state) %>% 
  gather(key = "age", value = "popul_in_thousands", -state, -year) %>% 
  mutate(age = str_replace(age, "x", ""))
```


#### Get Y and X for regression

Y: 51 states, each with mean crime rates (10 types of crimes)

```{r}
crime_mean_rate <- 
  crime_clean %>% 
  group_by(state) %>% 
  select(grep("rate",names(.))) %>% 
  summarise_all(funs(mean))
crime_mean_rate[,2:11] <- crime_mean_rate[,2:11]/100

# check dimension
dim(crime_mean_rate) #right
head(crime_mean_rate)
```

X: 51 states, each with mean drug rate (3 types of drugs)

```{r prepare the outcome and predictors}
# clean drug data
drug_mean_rate = drug_clean %>% 
  group_by(state, rate, age) %>% 
  summarize(drug_average = mean(value)) %>% 
  group_by(state, rate) %>% 
  summarize(drug_sum = sum(drug_average)) %>% 
  filter(!str_detect(rate, 'perceptions'),
         str_detect(rate, 'past_year')) %>% 
  mutate(rate = str_replace_all(rate, c("alcohol_" = "alcohol:", "illicit_drugs_" = "illicit_drugs:", "marijuana_" = "marijuana:"))) %>% 
  separate(rate, into = c("drug", "degree"), sep = ":", extra = "merge") %>% 
  select(-degree) %>% 
  group_by(state, drug) %>% 
  summarize(use_past_year = sum(drug_sum)) %>% 
# up to here, it's already a tidy dataset, but for regression we need to define each drug as a variable, so we choose to spread "drug" column
  spread(key = drug, value = use_past_year)

head(drug_mean_rate)

# read data for race proportion
race_data_raw = read_csv("./data/race_data.csv") %>% janitor::clean_names() %>%
  select(state, white)

# Combine X and Y into one data frame
regression_data_raw = left_join(crime_mean_rate, drug_mean_rate) %>% 
  select(-rape_legacy_rate)

regression_data_raw = left_join(regression_data_raw, race_data_raw)
```

Consider education as a new variable.

```{r read in new dataset}
# Import dataset that contains education information
url = "https://en.wikipedia.org/wiki/List_of_U.S._states_by_educational_attainment"
education = read_html(url)

# tidy and clean
education_data = education %>% 
  html_nodes(css = "table") %>%
  .[[1]] %>% 
  html_table(fill = TRUE) %>% 
  janitor::clean_names() %>% 
  select(state, percent_high_school_graduate) %>% 
  filter(state != "United States") %>% 
  mutate(percent_high_school_graduate = str_replace(percent_high_school_graduate, "%", "")) %>% 
  mutate(percent_high_school_graduate = as.numeric(percent_high_school_graduate))

regression_data_all = left_join(regression_data_raw, education_data)
```


#### Linear Regression

Check the distribution for variables.
```{r distribution checking}
# Check distributions 
regression_data_all %>%
  select(-state) %>%
  chart.Correlation()
```


Make models for MLR of crime types and drug uses, as well as race and education. 


```{r linear regression}
# MLR linear regression using list columns
regression_data_all %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")
```

From the result we could see that, both murder/manslaughter and robbery rate are positively related to marijuana use. In addition, murder/manslaughter rate is also related to illicit drugs. So, we would look into murder/manslaughter and robbery MLR models.

Check the diagnostics of the model.

```{r model diagnostics}
# Fit models and then check the assumption
model1 = lm(murder_manslaughter_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = regression_data_all)
summary(model1)
par(mfrow = c(2,2))
plot(model1)

model2 = lm(robbery_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = regression_data_all)
summary(model2)
par(mfrow = c(2,2))
plot(model2)
```

From the diagnostics, these two models meet the model assumptions.


* Try bootstrap of the model of burglary rate

```{r}
new_reg_data %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  filter(crime_type == "burglary_rate") %>% 
  modelr::bootstrap(n = 100) %>% 
  mutate(
    linear_model = map(strap, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + total_pop_thousands, data = .x)),
    results = map(linear_model, broom::tidy)) %>% 
  select(results) %>%
  unnest()
```

