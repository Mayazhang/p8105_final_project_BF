---
title: "p8105_Team34_Final_Project_Report"
author: "p8105_Final_Project_Team34"
date: "2018/12/3"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
library(rvest)
library(httr)
library(tidyverse)
```

```{r data importion, include=FALSE, warning=FALSE, message=FALSE}
# load data and clean up column names
# not to omit NAs
crime = readxl::read_excel("./data/crime-data-2016.xls", range = ("A4:W202")) %>% 
  janitor::clean_names() %>% 
    rename_(population = names(.)[3],
          violent_crime_number = names(.)[4],
          violent_crime_rate = names(.)[5],
          murder_manslaughter_number = names(.)[6],
          murder_manslaughter_rate = names(.)[7],
          rape_revise_number = names(.)[8],
          rape_revise_rate = names(.)[9],
          rape_legacy_number = names(.)[10],
          rape_legacy_rate = names(.)[11],
          robbery_number = names(.)[12],
          robbery_rate = names(.)[13],
          aggravated_assault_number = names(.)[14],
          aggravated_assault_rate = names(.)[15],
          property_crime_number = names(.)[16],
          property_crime_rate = names(.)[17],
          burglary_number = names(.)[18],
          burglary_rate = names(.)[19],
          larceny_theft_number = names(.)[20],
          larceny_theft_rate = names(.)[21],
          motor_vehicle_theft_number = names(.)[22],
          motor_vehicle_theft_rate = names(.)[23]) %>% 
  mutate(area = as.factor(area)) 
crime[,2:23] <- as.numeric(unlist(crime[,2:23]))

# fill up area name
i = 1
for (i in 0:65) {
  n = 3 * i + 1
  crime$area[n + 1] = paste0(crime$area[n]) 
  crime$area[n + 2] = paste0(crime$area[n])
  i = i + 1
}

crime  <- crime %>% 
  na.omit()

crime$year = as.factor(crime$year)


# Filter out "percent change" in "year" variable
crime_clean = 
  crime %>%
  filter(year != "NA")


# Change the name of "area" to "state"
colnames(crime_clean)[1] = "state"
```

```{r drug dataset load and clean up, include=FALSE, warning=FALSE, message=FALSE}
# Remove the block later
drug_raw =
  read_csv("./data/drugs.csv") %>%
  janitor::clean_names()

drug_clean = 
  drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", ""))

population_data = 
  drug_raw %>% 
  select(x12_17, x18_25:x26, year, state) %>% 
  gather(key = "age", value = "popul_in_thousands", -state, -year) %>% 
  mutate(age = str_replace(age, "x", ""))
```

```{r unit conversion, include=FALSE, warning=FALSE, message=FALSE}
# Unit convert for the crime rate
crime_mean_rate <- 
  crime_clean %>% 
  group_by(state) %>% 
  select(grep("rate",names(.))) %>% 
  summarise_all(funs(mean))
crime_mean_rate[,2:11] <- crime_mean_rate[,2:11]/100
```

```{r prepare the outcome and predictors, include=FALSE, warning=FALSE, message=FALSE}
# clean drug data
drug_mean_rate = drug_clean %>% 
  group_by(state, rate, age) %>% 
  summarize(drug_average = mean(value)) %>% 
  group_by(state, rate) %>% 
  summarize(drug_sum = sum(drug_average)) %>% 
  filter(!str_detect(rate, 'perceptions'),
         str_detect(rate, 'past_year')) %>% 
  mutate(rate = str_replace_all(rate, c("alcohol_" = "alcohol:", "illicit_drugs_" = "illicit_drugs:", "marijuana_" = "marijuana:"))) %>% 
  separate(rate, into = c("drug", "degree"), sep = ":", extra = "merge") %>% 
  select(-degree) %>% 
  group_by(state, drug) %>% 
  summarize(use_past_year = sum(drug_sum)) %>% 
# up to here, it's already a tidy dataset, but for regression we need to define each drug as a variable, so we choose to spread "drug" column
  spread(key = drug, value = use_past_year)

# read data for race proportion
race_data_raw = read_csv("./data/race_data.csv") %>% janitor::clean_names() %>%
  select(state, white)

# Combine X and Y into one data frame
regression_data_raw = left_join(crime_mean_rate, drug_mean_rate) %>% 
  select(-rape_legacy_rate)

regression_data_raw = left_join(regression_data_raw, race_data_raw)
```

```{r read in new dataset, include=FALSE, warning=FALSE, message=FALSE}
# Import dataset that contains education information
url = "https://en.wikipedia.org/wiki/List_of_U.S._states_by_educational_attainment"
education = read_html(url)

# tidy and clean
education_data = education %>% 
  html_nodes(css = "table") %>%
  .[[1]] %>% 
  html_table(fill = TRUE) %>% 
  janitor::clean_names() %>% 
  select(state, percent_high_school_graduate) %>% 
  filter(state != "United States") %>% 
  mutate(percent_high_school_graduate = str_replace(percent_high_school_graduate, "%", "")) %>% 
  mutate(percent_high_school_graduate = as.numeric(percent_high_school_graduate))

regression_data_all = left_join(regression_data_raw, education_data)

regression_data_no2states <- regression_data_all %>% 
  filter(!state %in% c("District of Columbia", "Hawaii"))

result_withoutoutliers = 
  regression_data_no2states %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>%
  mutate_if(is.numeric, round, 2)
```

```{r linear regression, include=FALSE, warning=FALSE, message=FALSE}
# MLR linear regression using list columns
regression_data_all %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  filter(p.value < 0.05,
         term != "(Intercept)")

result_withoutliers = 
  regression_data_all %>%
  gather(key = crime_type, value = crime_rate, violent_crime_rate:motor_vehicle_theft_rate) %>%
  group_by(crime_type) %>%
  nest() %>%
  mutate(
    linear_model = map(data, ~lm(crime_rate ~ illicit_drugs + alcohol + marijuana + white + percent_high_school_graduate, data = .x)),
    linear_model = map(linear_model, broom::tidy)) %>%
  select(-data) %>%
  unnest() %>% 
  mutate_if(is.numeric, round, 2)
```

##Background

Substance abuse is characterized by the repeated use of addictive drugs that changes neuroadaptations in the neural system, resulting in the withdrawal syndrome after the drug effects diminish (White, 2004). A study of arrestees in Maricopa County, Arizona suggests that diverted medical marijuana users were more likely to commit property crime, violent crime, Driving Under the Influence (DUI), and drug selling than nonusers (Katz et al., 2018). Therefore, not only substance abuse represents a significant public health problem, but alcohol and illicit drug use are also associated with criminal activities in the United States (Jaegers et al., 2018). For example, the United States Drug Enforcement Administration (DEA) reports a majority of drug related crimes are committed by drug users (Resignato, 2000), and the evidence of high rates of drug misuse among criminal samples suggests an association between crime and illegal drug use (Rolfe et al., 2000). Furthermore, studies have shown more crime-related activity during periods of addiction than non-addiction periods (Rolfe et al., 2000). Substance use disorders (SUDs) as defined by the Diagnostic and Statistical Manual of Mental Disorders, Fourth Edition (DSM-IV) for alcohol, marijuana, and pain relievers are associated with violence (Grant et al., 2018). Motivation for committing property crimes can be attributed to economic problems. For instance, many heroin addicts finance their habits through committing property crimes, especially theft. (Rolfe et al., 2000). For violent crimes, the majority of murders linked to drug addicts are associated to the drug trade (Harrison & Gfroerer, 1992). 

There is a substantial decline in both the violent crime rate and property crime rate since 1993 (“5 facts about crime in the U.S”, 2018). However, the FBI reported a 7% increase in the violent crime rate between 2014 and 2016, with a 20% increase in the murder rate (“5 facts about crime in the U.S”, 2018). Consistent with the decrease in crime rates, past year cocaine use has fallen since 2002 (“Nationwide Trends”, 2015). Both marijuana and illicit drugs use increased slightly after 2008 (“Nationwide Trends”, 2015). Although the relationship between drug use and crime has been studied in detail these years, it is not clear whether the drug use pattern can be used to inform or even predict different types of crimes. The main purpose of the study is to build a predictive model using regression to predict future crime trend from drug use information. 



##Data: Source, scraping method, cleaning, etc.

1. Crime dataset

1.1 Data description

The data was collected by FBI's Uniform Crime Reporting (UCR) Program, which recorded different types of offenses by states, regions, or geographic divisions. The data presented each crime by volumn and rate per 100,000 inhabitants. Detailed description of columns were as follow:

 * state: state names
 
 * year: year the offense recorded
 
 * population: total population of the state
 
 * violent_crime_number/rate: violent crime involved force or threat of force against the victims. It included four types of offenses: murder and nonnegligent manslaughter, rape, robbery, and aggravated assault. 
 
 * columns containing murder manslaughter, rape, robbery, and aggravated assault were subdivision of violent crime
 
 * property_crime_number/rate: property crime indicated offenses involving property lost without force or threat of force. It included three types of offenses: burglary, larceny-theft, motor vehicle theft.
 
 * columns containing burglary, larceny-theft, and motor vehicle theft were subdivision of property crime

1.2 Data cleaning 

The crime dataset was loaded from the [google sheet](https://docs.google.com/spreadsheets/d/1iYhSFxs_IdRDrfrn1xqdK6uesNKWRjCIJ2GYloO0Ll8/edit#gid=249460096), detailed data cleaning steps were as follow:

 * Clean up column names using 'janitor' packages and manually delete the subscripts of text
 
 * Convert column 'area' from character to factor
 
 * Remove comma in columns containing numbers and rates, followed by transformation from character to numeric
 
 * Fill up area names where appropriate
 
 * Remove 'rape_legacy' related columns as it has overlapping information with 'rape_revise' columns
 
 * Remove NAs and create subsets by states, region, and geographic division

2. Drug dataset

2.1 Data description

This dataset is about substance abuse (cigarettes, marijuana, cocaine, alcohol) among different age groups (12-17, 18-25, 26 or above) and states in United States from year 2002 to 2014. Data was collected from individual state as part of the NSDUH study. 

2.2 Data cleaning

The dataset can be accessed through its [original website](https://think.cs.vt.edu/corgis/csv/drugs/drugs.html), detailed data cleaning steps were as follows: 
 
  Mainly focusing on the substance abuse of marijuana, illicit drug (cocaine) and alcohol, so firstly all related columns from the whole dataset were selected, including state, year and rate of different substance abuse in different age groups. Since the age groups and substance type were nested together in the column names, all the columns except year and state were gathered and then the strings were replaced before the age number for later separating. Finally, the data was separated into “age” and “rate” which resulted in a tidy dataset.
  
3. Education data

In order to take education rate as a possible confounder in regression models, percentage of high school graduation in each state was extracted from a [wikipedia website](https://en.wikipedia.org/wiki/List_of_U.S._states_by_educational_attainment) and combined it with original dataset. 
 
4. Race data

Taking the race proportion into consideration, we added proportion of whites as a confounder. It was extracter from [Kaiser Family Foundation](https://www.kff.org/other/state-indicator/distribution-by-raceethnicity/?currentTimeframe=0&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D)

##Exploratory analysis: Visualizations, summaries, and exploratory statistical analyses. Justify the steps you took, and show any major changes to your ideas.

In order to visualize how the crime rate differs in different areas, regions and states, we made a barplot to show the distribution of crime rate at different geographic levels.

* Line plots to show trend of drug use across years

```{r ,echo=FALSE, warning=FALSE}
# retidy the data for plot
drug_raw %>%
  select(year, state,
         rates_alcohol_abuse_past_year_12_17:rates_alcohol_dependence_past_year_26,
         rates_alcohol_need_treatment_past_year_12_17:rates_illicit_drugs_abuse_past_month_26, 
         rates_illicit_drugs_cocaine_used_past_year_12_17:rates_illicit_drugs_need_treatment_past_year_26,
         rates_marijuana_new_users_12_17:rates_marijuana_used_past_year_26) %>%
  gather(key, value, -state, -year) %>% 
  mutate(key = str_replace_all(key, c("year_" = "year:", "month_" = "month:", "risk_" = "risk:", "users_" = "users:"))) %>%
  separate(key, into = c("rate", "age"), sep = ":", extra = "merge") %>%
  mutate(rate = str_replace(rate, "^rates_", "")) %>% 
# Make a line plot 
    filter(!str_detect(rate, "perceptions"),
         !str_detect(rate, "past_month"),
         !str_detect(rate, "new_user")) %>% 
  mutate(rate = str_replace(rate, "alcohol_", "alcohol:"),
         rate = str_replace(rate, "illicit_drugs_", "illicit_drugs:"),
         rate = str_replace(rate, "marijuana_", "marijuana:")) %>% 
  separate(rate, into = c("drug", "other"), by = ":") %>% 
  select(-other) %>%
  group_by(year, drug, age) %>% 
  summarize(average_rate = mean(value)) %>% 
  ggplot(aes(x = year, y = average_rate, 
             color = drug, 
             group = interaction(age, drug))) +
  geom_line() +
  geom_point(aes(shape = age)) +
  theme_bw() +
  labs(
    title = "Drug use in 2002-2014 by age group",
    x = "Year",
    y = "Average rate of drug use (in thousands)",
    caption = "Data from the drug dataset"
  ) +
   theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(2002, 2004, 2006, 2008, 2010, 2012, 2014))
```


* Process of building shiny for drug data:

As there were 51 states, three types of drugs (marijuana, illicit drug, alcohol), three age groups (12-17, 18-25, 26 or above) and four or five degrees in each drug (abuse, binge, dependence, need treatment, use). The main purpose was to analyze the distribution of degrees in each drug in each state through years and also the distribution of degrees of each drug in a specific age group. Moreover, there were data for rate of perception risk in marijuana and alcohol use, thus we  analysis of the trend of perception risk in each age group and in each state for selected drug were further conducted. Thus,three interactive charts in total were created for exploring.

In chart A, specific state and drug type been selected were firstly filtered and then an interactive bar chart with “year” as x axis, “rate” as y axis was built and different degrees with different colors. In chart B, similarly mainly focusing on the change through years about proportion of people in each state obtained perception of risk of a certain drug in different age groups. Thus, all perception risk rates were selected and then different colors were assigned to each age group. In chart C, attaching the importance to the trend over years on different age groups in each drug type and in each state. As a result, each degree was colored to show the change in a certain group.

By showing all these three types of distribution, the reader could explore the every detailed information of the drug use in U.S. and across years.

Finally, best to show the different rates in each drug use overall the whole country, a shiny map was made to explore the distribution of each drug use through U.S. and the shades of the color was related to the rates.



##Additional analysis: If you undertake formal statistical analyses, describe these in detail

* Linear Regression:

We are interested in the association between the crime rate and the drug use, so we undertake multivariable linear regression to test the significance of the estimated coefficients.
The rates of various crime types are considered to be the outcome, and the amount of drug (illicit drug, alcohol and marijuana) use, race proprtion of white people, rate of high school graduation are the predictors.

We checked the overal distribution of outcomes and variables using package "PerformanceAnalytics". Because of the relatively small sample size, the distributions could not be exactly normal, and we do not use transformation for the outcomes.


We fitted the models and obtain the results for each regression.
`r datatable(result_withoutliers, options = list(pageLength = 10))`


We filtered the estimated coefficients with p-value less than 0.05. We found that there are two outcomes (murder/manslaughter, robbery) are significantly related to drug use (illicit drug and marijuana). Then we run the diagnostics for these two multivariable linear regression models. There are two leverages and they are also influential points (Cook's distance > 0.5). These two influential points are from state "Hawaii" and "District of Columbia".

We tried to remove these two outliers, and then fitted models again. 
`r datatable(result_withoutoutliers, options = list(pageLength = 10))`

The R-squared and adjusted R-squared increased by approximately 0.3, indicating a higher goodness of fit. However, the estimated coefficients of drug use became unsiginficent (p-value > 0.05).

After we fitted the models and obtain the results for each regression, we filtered the estimated coefficients with p-value less than 0.05, we found that there are two outcomes (murder/manslaughter, robbery) are significantly related to drug use (illicit drug and marijuana). Then we ran the diagnostics for these two multivariable linear regression models. They were all good with model assumptions.

In conlusion, with data from Hawaii and District of Columbia, at 0.05 significant level, murder/manslaughter is negatively associated with illicit drug, while robbery and murder/manslaughter are positively associated with marijuana use. Without data from Hawaii and District of Columbia, at 0.05 significant level, the race proportion of white people and percentage of high school graduation become the main predictors. They are both negatively related to the outcomes (murder_manslughter_rate, robbery_rate, violent_crime_rate, aggravated_assault_rate, motor_vehicle_theft_rate, property_crime_rate, burglary_rate).

##Discussion: What were your findings? Are they what you expect? What insights into the data can you make?

Our finding are that, in general, the crime rate is highly related to alcohol, marijuana or illicit drug use. It is more associated to the race proportion of whites and the percentage of high school graduation.

These result are not we initially expect, as the crime rate is not highly significantly associated with these drug use.







